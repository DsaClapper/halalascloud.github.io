<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Halalas Cloud DashBoard</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/halalas_cloud_apple.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="180x180"
      href="/halalas_cloud_apple.png"
    />
    <link rel="icon" type="image/png" href="halalas_cloud32.png" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="cyan"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="black"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
  </head>
  <link
    rel="stylesheet"
    href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css"
  />
  <script src="//code.jquery.com/jquery-1.12.4.js"></script>
  <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="../css/dash.css" />

  <body>
    <div class="container">
      <div class="file-page" hidden="true" id="file-page-div">
        <div id="text-elements">
          <h1 style="margin: 0">Files</h1>
          <input
            type="file"
            id="file-box"
            hidden="true"
            accept=".png, .jpeg, .jpg, .gif, .txt"
          />
          <input
            type="button"
            id="file-button"
            hidden="true"
            value="+"
            onclick="OpenSelection()"
          />
          <p id="msg"></p>
        </div>
      </div>
      <div class="main-page" id="main-page" style="display: none">
        <div class="logout">
          <button onclick="logout()" style="font-size: 20px" id="logoutbtn">
            Logout
          </button>
        </div>
        <div id="elements">
          <h1>Your Files</h1>
          <input
            type="button"
            value="Access Your Files"
            onclick="changePage()"
          />
        </div>
      </div>
      <div class="logout-popup" hidden="true" style="display: none">
        <div id="logout-buttons" class="logout-buttons">
          <button
            id="confirm"
            style="
              margin: 10px;
              padding: 10px;
              background-color: rgb(9, 9, 121);
              cursor: pointer;
            "
          >
            Confirm
          </button>
          <button
            id="cancel"
            style="
              margin: 10px;
              padding: 10px;
              cursor: pointer;
              background-color: white;
            "
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div id="loading-page" style="display: block" class="loading-page">
      <div id="loading-container" class="loading-container">
        <div
          id="loading-text"
          style="font-size: 30px; color: white; font-family: Supr"
        >
          Loading
        </div>
        <div id="progress-bar">
          <div id="progress"></div>
        </div>
        <!-- <div id="spinner"></div> -->
      </div>
    </div>
  </body>
  <script>
    async function pageload() {
      // if (await !localStorage.getItem("email")) return (window.location = "/");
      fetch("http://51.20.5.168:2000/ipse", {
        method: "POST",
        crossDomain: true,
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
          "Access-Control-Allow-Origin": "*",
        },
        body: JSON.stringify({
          ip: localStorage.getItem("ip"),
          e: localStorage.getItem("email"),
          a: localStorage.getItem("autologin"),
        }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((data) => {
          if (data != "ok") return (window.location = "/");
        });
      // fetch(
      //     `/ipsend?ip=${localStorage.getItem("ip")}&email=${localStorage.getItem(
      //         "email"
      //     )}`
      // )
    }
    const fileInput = document.getElementById("file-box");

    fileInput.addEventListener("change", (e) => {
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async function (e) {
        const base64 = e.target.result;
        const fileName = file.name;

        fetch("http://51.20.5.168:2000/imgsend", {
          method: "POST",
          crossDomain: true,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            e: localStorage.getItem("email"),
            data: e.target.result,
            name: fileName,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.text();
          })
          .then((data) => {
            if (data === "exists") {
              document.getElementById("msg").innerHTML =
                "This Image Already Exists On The Cloud!";
            } else {
              window.location.reload();
              // document.getElementById("msg").innerHTML = "Saved! Refresh To Use The Image!"
            }
          });
        fileInput.value = "";
      };
      reader.readAsDataURL(file);
    });

    function getFiles() {
      fetch("http://51.20.5.168:2000/bringimgs", {
        method: "POST",
        crossDomain: true,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          em: localStorage.getItem("email"),
        }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((data) => {
          let json = JSON.parse(data);
          let objval = Object.values(json).map((m) => m.base);
          let objkeys = Object.keys(json);
          let i = 0;
          objval.forEach((l) => {
            let splitt = l.split(";")[0].split(":")[1];
            if (splitt.startsWith("image")) {
              let img = document.createElement("img");
              let newImg = document
                .getElementById("file-page-div")
                .appendChild(img);
              newImg.id = objkeys[i];
              newImg.className = "images";
              newImg.src = l;
              newImg.width = 200;
            } else if (splitt.startsWith("text")) {
              let file = document.createElement("a");
              let newFile = document
                .getElementById("file-page-div")
                .appendChild(file);
              newFile.id = objkeys[i];
              newFile.className = "files";
              newFile.href = l;
              newFile.addEventListener("click", OpenUrl);
              newFile.innerHTML = objkeys[i];
            }
            i++;
          });
        });
    }

    function OpenUrl(e) {
      const src = e.srcElement.href.split(",")[1];
      const byteCharacters = atob(src);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: "text/plain" });
      var imageUrl = URL.createObjectURL(blob);
      window.open(imageUrl, "bla");
    }
    async function changePage() {
      $(".main-page").hide("drop", { direction: "right" }, 500);
      $(".file-page").show("drop", { direction: "left" }, 500);
      $("#file-button").fadeIn(1000);
      // $("#main-page").hide("slide", { direction: "right" }, 250, function () {
      //     $(".file-page").fadeIn("fast")//);
      // });
    }

    function OpenSelection() {
      document.getElementById("file-box").click();
    }

    $(document).ready(Ready());

    function progressBar() {
      let i = 0;
      let pr = document.getElementById("progress");
      let text = document.getElementById("loading-text");
      let dots = [".", "..", "..."];
      let d = 0;
      if (i == 0) {
        setInterval(() => {
          if (i <= 100) {
            pr.style.width = i++ + "%";
          }
        }, 10);
        if (i <= 100) {
          setInterval(() => {
            if (d === 3) {
              d = 0;
            }
            if (d < dots.length) {
              text.innerHTML = `Loading${dots[d]}`;
              d++;
            }
          }, 150);
        }
      }
    }

    function Ready() {
      progressBar();
      $("#main-page").fadeIn(1000, function () {
        $("#loading-page").fadeOut(250);
      });
    }

    function logout() {
      $(".logout-popup").show(1000);
      document.getElementById("main-page").style.filter = "blur(4px)";
      document.getElementById("main-page").style.transition = "filter 4s";

      $("#cancel").click(() => {
        $(".logout-popup").hide(1000);
        document.getElementById("main-page").style.filter = "blur(0px)";
        document.getElementById("main-page").style.transition = "filter 2s";
      });
      $("#confirm").click(() => {
        localStorage.clear();
        window.location = "/";
      });
    }
    function setBodyHeight() {
      document.body.style.height = window.innerHeight + "px";
    }
    window.onload = pageload();
    window.onload = getFiles();
    // Initial call to set body height
    setBodyHeight();
  </script>
</html>
